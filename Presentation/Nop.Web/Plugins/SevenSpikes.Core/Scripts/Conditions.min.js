/*
* Copyright 2016 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

function UpdateCondition(){var e=sevenSpikes.getHiddenValFromDom("#update-condition-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id"),o=$("#conditionInfo *").serialize();o+="&conditionId="+t;var n={};n.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:o,url:e,success:function(){},headers:n,error:function(e,t,o){alert("Updating condition failed.")}})}function UpdateDefaultConditionStatement(){var e=sevenSpikes.getHiddenValFromDom("#update-default-condition-group-statement-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id"),o=$("#DefaultConditionValue").find(":selected").val(),n={};n.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:{conditionId:t,defaultConditionStatementValue:o},url:e,success:function(){},headers:n,error:function(e,t,o){alert("Updating condition default group statement failed.")}})}function DisplayExistingConditions(){var e=$.parseJSON(sevenSpikes.getHiddenValFromDom("#condition-groups"));if(null!=e)for(var t=0;t<e.length;t++)AddConditionGroup(e[t])}function AddConditionGroup(e){if(e&&0!=e)AddConditionGroupGridHtml(e);else if(e=CreateConditionGroupAndAddConditionGroupGridHtml(),""==e)return;addKendoGridForConditionGroup(e)}function addKendoGridForConditionGroup(e){var t="condition-group-grid-"+e,o=sevenSpikes.getHiddenValFromDom("#read-condition-group-url"),n=sevenSpikes.getHiddenValFromDom("#update-condition-statement-url"),i=sevenSpikes.getHiddenValFromDom("#destroy-condition-statement-url"),d=sevenSpikes.getHiddenValFromDom("#create-condition-statement-url"),a={},r=0,l=new kendo.data.DataSource({transport:{read:{url:o,cache:!1,dataType:"json",contentType:"application/json",data:addAntiForgeryToken},update:{url:n,type:"POST",dataType:"json",contentType:"application/json",data:addAntiForgeryToken},destroy:{url:i,cache:!1,dataType:"json",contentType:"application/json",data:addAntiForgeryToken},create:{url:d,type:"POST",dataType:"json",contentType:"application/json",data:addAntiForgeryToken},parameterMap:function(t,o){return"update"===o||"create"===o?kendo.stringify(a):"read"===o?{conditionGroupId:kendo.stringify(e)}:"destroy"===o?{conditionStatementId:kendo.stringify(r)}:void 0}},batch:!0,pageSize:30,schema:{model:{id:"Id",fields:{ConditionType:{type:"text"},ConditionTypeId:{type:"number"},ConditionPropertyValue:{type:"number"},ConditionPropertyText:{type:"text"},OperatorTypeText:{type:"text"},OperatorTypeValue:{type:"number"},Text:{type:"text"},Value:{type:"text"}}}}});$("#"+t).kendoGrid({dataSource:l,sortable:!0,editable:{mode:"popup",template:kendo.template($("#popup_editor").html()),window:{animation:!1,width:400}},edit:function(e){var t=e.model;void 0!=t.ConditionType&&void 0!=t.ConditionPropertyValue&&void 0!=t.OperatorTypeValue&&void 0!=t.Value&&($("#condition-type").attr("data-editValue",t.ConditionTypeId),$("#condition-property").attr("data-editValue",t.ConditionPropertyValue),$("#condition-operator").attr("data-editValue",t.OperatorTypeValue),$("#condition-value").attr("data-editValue",t.Value),$("#condition-num-value").attr("data-editValue",t.Value),$("#condition-text-value").attr("data-editValue",t.Value))},save:function(t){a.ConditionGroupId=e,a.ConditionTypeId=$("#condition-type").val(),a.ConditionPropertyValue=$("#condition-property").val(),a.OperatorTypeValue=$("#condition-operator").val();var o=$("#condition-value").parents(".k-dropdown").css("display"),n=$("#condition-num-value").parents(".k-numerictextbox").css("display"),i=$("#condition-text-value").css("display");if(o&&"none"==o?n&&"none"==n?i&&"none"==i||(a.Value=$("#condition-text-value").val()):a.Value=$("#condition-num-value").val():a.Value=$("#condition-value").val(),void 0!=t.model.ConditionType)for(var d=l.data(),r=0;r<d.length;r++)d[r].Id==t.model.Id&&(a.Id=t.model.Id,d[r].dirty=!0)},remove:function(e){if(void 0!=e.model.Id&&""!=e.model.Id)for(var t=l.data(),o=0;o<t.length;o++)t[o].Id==e.model.Id&&(r=e.model.Id,t[o].dirty=!0)},toolbar:["create","destroy"],columns:[{field:"Id",title:"Id",width:100,hidden:!0},{field:"ConditionType",title:"Type",width:100},{field:"ConditionPropertyText",title:"Property",width:100},{field:"OperatorTypeText",title:"OperatorType",width:100},{field:"Text",title:"Text",width:250},{field:"Value",title:"Value",width:200,hidden:!0},{command:["edit","destroy"],title:"&nbsp;",width:"150px"}]})}function DeleteConditionGroup(e,t){var o=sevenSpikes.getHiddenValFromDom("#delete-condition-group-url"),n={conditionGroupId:e},i={};i.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,type:"POST",data:$.toJSON(n),contentType:"application/json; charset=utf-8",url:o,success:function(){$("#"+t).data("kendoGrid").destroy(),$("#"+t).parent().remove()},headers:i,error:function(e,t,o){alert("Deleting condition group failed.")}})}function AddViewModel(){var e=kendo.observable({typeSource:GetConditionTypes(),selectedType:null,selectedProperty:null,selectedOperator:null,selectedValue:null});e.selectedType=SetSelectedConditionType(e.typeSource),e.selectedProperty=SetSelectedConditionProperty(e.selectedType),e.selectedOperator=SetSelectedOperatorType(e.selectedProperty),e.selectedValue=function(){var e,t=$("#condition-value").parents(".k-dropdown").css("display"),o=$("#condition-num-value").parents(".k-numerictextbox").css("display"),n=$("#condition-text-value").css("display");return t&&"none"==t?o&&"none"==o?n&&"none"==n||(e=$("#condition-text-value").attr("data-editValue")):e=$("#condition-num-value").attr("data-editValue"):e=$("#condition-value").attr("data-editValue"),void 0!=e&&""!=e?e:null},kendo.bind($("#editor"),e)}function SetSelectedConditionType(e){var t=$("#condition-type").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.length;o++)if(e[o].ConditionTypeId==t)return e[o];return null}function SetSelectedConditionProperty(e){var t=$("#condition-property").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.ConditionProperties.length;o++)if(e.ConditionProperties[o].ConditionPropertyValue==t)return e.ConditionProperties[o];return null}function SetSelectedOperatorType(e){var t=$("#condition-operator").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.Operators.length;o++)if(e.Operators[o].OperatorTypeValue==t)return e.Operators[o];return null}function GetConditionTypes(){var e=sevenSpikes.getHiddenValFromDom("#get-condition-type-url"),t=sevenSpikes.getHiddenValFromDom("#available-condition-types"),o={};o.__RequestVerificationToken=addAntiForgeryToken();var n;return $.ajax({cache:!1,async:!1,type:"POST",contentType:"application/json; charset=utf-8",data:$.toJSON({availableConditionTypesIds:t}),url:e,success:function(e){n=e},headers:o,error:function(e,t,o){alert("Retrieving condition types failed.")}}),n}function CreateConditionGroupAndAddConditionGroupGridHtml(){var e=sevenSpikes.getHiddenValFromDom("#create-condition-group-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id");if(""==e||""==t)return 0;var o={conditionId:t},n={};n.__RequestVerificationToken=addAntiForgeryToken();var i="";return $.ajax({cache:!1,async:!1,type:"POST",headers:n,data:$.toJSON(o),contentType:"application/json; charset=utf-8",url:e,success:function(e){i=e,AddConditionGroupGridHtml(i)},error:function(e,t,o){alert("Creating new condition group failed.")}}),i}function AddConditionGroupGridHtml(e){var t="condition-group-grid",o="condition-group-grid-"+e,n='<div><div class="'+t+'" id="'+o+'" data-conditionGroupId="'+e+'"></div><div class="group-dependancy-text"><p>--OR--</p></div></div>';$("#condition-groups-wrapper").append(n)}$(document).ready(function(){DisplayExistingConditions(),$("a.add-condition-group").click(function(){AddConditionGroup()}),$(".k-grid-toolbar a.k-grid-delete").livequery("click",function(){var e=$(this).closest(".condition-group-grid");if(void 0!=e){var t=$(e).attr("data-conditionGroupId"),o=$(e).attr("id");void 0!=t&&void 0!=o&&DeleteConditionGroup(t,o)}}),$("#conditionInfo #ConditionName, #conditionInfo #Active").change(function(){UpdateCondition()}),$("#DefaultConditionValue").change(function(){UpdateDefaultConditionStatement()})}),$("#editor").livequery(function(){AddViewModel()}),$(window).unload(function(){var e=sevenSpikes.getHiddenValFromDom("#delete-unused-condition-groups-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id"),o={conditionId:t},n={};n.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:$.toJSON(o),contentType:"application/json; charset=utf-8",url:e,success:function(){},headers:n,error:function(e,t,o){alert("Deleting condition failed.")}})});
