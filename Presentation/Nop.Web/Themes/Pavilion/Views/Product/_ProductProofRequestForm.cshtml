@model ProductDetailsModel
@using Nop.Core.Domain.Seo;
@using Nop.Core.Domain.Orders;
@using Nop.Core.Infrastructure;
@using Nop.Web.Models.Catalog;
@using Nop.Web.Framework.Themes
@using Nop.Core;
@using Nop.Services.Security;
@using Nop.Core.Domain.Customers;
@{
    Layout = null;

    var _workContext = EngineContext.Current.Resolve<IWorkContext>();
    var CurrentCustomer = _workContext.CurrentCustomer;

    Html.AddCssFileParts("~/Scripts/fineuploader/fineuploader-4.2.2.min.css");
    Html.AddScriptParts("~/Scripts/fineuploader/jquery.fineuploader-4.2.2.js");

    var downloadService = EngineContext.Current.Resolve<Nop.Services.Media.IDownloadService>();
    var themeName = EngineContext.Current.Resolve<IThemeContext>().WorkingThemeName;
    var controlId = "Proof-artUpload";
}
<style>
    .ui-dialog {
        width: auto !important;
    }
</style>

<div id="proof-dialog" title="Proof Request Form" style="display:none;">
    @{
    <form method="post" action="@Url.Action("ProductDetails","Product")" id="product-details-proof-request-form" style="padding: 10px 20px;">
        <input type="hidden" value="@Model.Sku" name="proofrequest-sku" id="proofrequest-sku" />
        <input type="hidden" value="@Model.Name" name="proofrequest-product-name" id="proofrequest-product-name" />
        <input type="hidden" value="@Model.Id" name="id" />

        <div class="attributes-form">
            <dl>
                <dt style="float:left;">
                    <label class="text-prompt">
                        Item Color
                    </label>
                </dt>
                <dd style="float:left;">
                    <select name="Proof-ItemColor" id="Proof-ItemColor" class="form-control">
                        @{var ProofItemColors = Model.ProductAttributes.Where(x => x.Name.ToLower().Contains("item color")).FirstOrDefault();
                        }
                        @if (ProofItemColors != null)
                        {
                            foreach (var attributeValue in ProofItemColors.Values)
                            {
                                <option selected="@attributeValue.IsPreSelected" value="@attributeValue.Name">
                                    @attributeValue.Name
                                </option>
                            }
                        }
                    </select>
                </dd>
                <dt style="float:left;">
                    <label class="text-prompt">
                        Imprint Color
                    </label>
                </dt>
                <dd style="float:left;">
                    <select name="Proof-ImprintColor" id="Proof-ImprintColor" class="form-control">
                        @{var ProofImprintColor = Model.ProductAttributes.Where(x => x.Name.ToLower().Contains("imprint color")).FirstOrDefault();
                        }
                        @if (ProofImprintColor != null)
                        {
                            foreach (var attributeValue in ProofImprintColor.Values)
                            {
                                <option selected="@attributeValue.IsPreSelected" value="@attributeValue.Name">
                                    @attributeValue.Name
                                </option>
                            }
                        }
                    </select>
                </dd>
                <dt style="float:left;">
                    <label class="text-prompt">
                        Imprint Text
                    </label>
                </dt>
                <dd style="float:left;">
                    @{var ProofImprinLines = Model.ProductAttributes.Where(x => x.Id == 15 || x.Name.ToLower().Contains("imprint line(s)")).FirstOrDefault();
                    }
                    @if (ProofImprinLines != null)
                    {
                        foreach (var a in ProofImprinLines.Values)
                        {
                            <input name="Proof-ImprintText" value="@a.DefaultValue" type="text" class="textbox" id="@(a.Id)" placeholder="@a.Name" style="margin-top:5px;" />
                            <br />
                        }
                    }

                </dd>
                <dt style="float:left;">
                    <label class="text-prompt">
                        Comments
                    </label>
                </dt>
                <dd style="float:left;">
                    <textarea name="Proof-Comment" class="textbox" id="Proof-Comment" style="margin-top:5px;"></textarea>
                </dd>
                <dt style="float:left;">
                    <label class="text-prompt">
                        Art Upload
                    </label>
                </dt>
                <dd style="float:left;">
                    <input id="@(controlId)" name="@(controlId)" type="hidden" />
                    <div id="@(controlId)uploader"></div>
                    <script type="text/template" id="@(controlId)-qq-template">
                        <div class="qq-uploader-selector qq-uploader">
                            <div class="qq-upload-drop-area-selector qq-upload-drop-area" qq-hide-dropzone>
                                <span>@T("Common.FileUploader.DropFiles")</span>
                            </div>
                            <div class="qq-upload-button-selector qq-upload-button">
                                <div>@T("Common.FileUploader.Upload")</div>
                            </div>
                            <span class="qq-drop-processing-selector qq-drop-processing">
                                <span>@T("Common.FileUploader.Processing")</span>
                                <span class="qq-drop-processing-spinner-selector qq-drop-processing-spinner"></span>
                            </span>
                            <ul class="qq-upload-list-selector qq-upload-list">
                                <li>
                                    <div class="qq-progress-bar-container-selector">
                                        <div class="qq-progress-bar-selector qq-progress-bar"></div>
                                    </div>
                                    <span class="qq-upload-spinner-selector qq-upload-spinner"></span>
                                    <span class="qq-edit-filename-icon-selector qq-edit-filename-icon"></span>
                                    <span class="qq-upload-file-selector qq-upload-file"></span>
                                    <input class="qq-edit-filename-selector qq-edit-filename" tabindex="0" type="text">
                                    <span class="qq-upload-size-selector qq-upload-size"></span>

                                    <div class="custome_upload">
                                        <ul>
                                            <li><a class="qq-upload-cancel-selector qq-upload-cancel" href="#">@T("Common.FileUploader.Cancel")</a></li>
                                            <li><a class="qq-upload-retry-selector qq-upload-retry" href="#">@T("Common.FileUploader.Retry")</a></li>
                                            @*<li><a class="qq-upload-delete-selector qq-upload-delete" href="#">@T("Common.FileUploader.Delete")</a></li>*@
                                        </ul>
                                    </div>




                                    <span class="qq-upload-status-text-selector qq-upload-status-text"></span>
                                </li>
                            </ul>
                        </div>
                    </script>
                    <script type="text/javascript">
                            $(document).ready(function () {
                                var themeName1 = '@themeName';
                                var path = "/Themes/" + themeName1 + "/Content/img/download.png";
                                $("#@(controlId)uploader").fineUploader({
                                    request: {
                                        endpoint: '@(Url.Action("UploadArtWork","Product"))'
                                    },
                                    template: "@(controlId)-qq-template",
                                    multiple: false,
                                }).on("complete", function (event, id, name, responseJSON, xhr) {

                                    $("#@(controlId)").val(responseJSON.downloadGuid);
                                    if (responseJSON.success) {
                                        $("#@(controlId + "downloadurl")").html("<a title='@T("Common.FileUploader.DownloadUploadedFile")' class='download-uploaded-file' href='" + responseJSON.downloadUrl + "'><img class='custom-upload-image' src='" + path + "'/></a>");
                                        $("#@(controlId + "remove")").show();
                                        $("#@(controlId + "filename") p").html(responseJSON);
                                        $(".qq-upload-cancel").hide();
                                        $(".qq-upload-retry").hide();
                                        $(".qq-upload-delete").hide();
                                        $(".qq-upload-button").hide();
                                        $(".qq-upload-success").css("background-color", "none !important");
                                        //$(".qq-upload-success").hide();
                                    }
                                    if (responseJSON.message) {
                                        alert(responseJSON.message);
                                    }
                                });

                                $("#@(controlId + "remove")").click(function (e) {
                                    $(".qq-upload-button").show();
                                    $("#@(controlId + "downloadurl")").html("");
                                    $("#@(controlId + "filename") p").hide();
                                    $("#@(controlId + "uldownloadurl")").hide("");
                                    $("#@(controlId)").val('');
                                    $(".qq-upload-success").hide();
                                    $(this).hide();
                                });
                            });
                    </script>
                    <div class="custome_remove">
                        <ul id="@(controlId + "uldownloadurl")" style="display:none;">
                            <li style="width:100%;word-break: break-all;padding-bottom: 0px !important;margin-bottom: 0px;">
                                <div id="@(controlId + "filename")">

                                </div>
                            </li>
                        </ul>
                        <ul>

                            <li>
                                <div id="@(controlId + "downloadurl")">

                                </div>
                            </li>
                            <li>
                                <div>
                                    <a id="@(controlId + "remove")" title="@T("Common.FileUploader.RemoveDownload")" class="remove-download-button" style="display: none;"><img class='custom-upload-image' src="@string.Format("/Themes/{0}/Content/img/remove-icon.png", themeName)" /></a>
                                </div>
                            </li>
                        </ul>
                    </div>

                </dd>
            </dl>
        </div>
        <br />
        <div class="edit-address proofrequstform-shipping-info">

            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.Company, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.Company)
                @if (Model.FillShippingInfoProof.CompanyRequired)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.Company)
            </div>

            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.FirstName, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.FirstName)
                @Html.RequiredHint()
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.FirstName)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.LastName, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.LastName)
                @Html.RequiredHint()
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.LastName)

            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.Email, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.Email)
                @Html.RequiredHint()
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.Email)
            </div>

            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.Address1, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.Address1)
                @if (Model.FillShippingInfoProof.StreetAddressRequired)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.Address1)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.Address2, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.Address2)
                @if (Model.FillShippingInfoProof.StreetAddress2Required)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.Address2)
            </div>

            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.City, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.City)

                @if (Model.FillShippingInfoProof.CityRequired)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.City)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.CountryId, new { }, ":")
                @Html.DropDownListFor(model => model.FillShippingInfoProof.CountryId, Model.FillShippingInfoProof.AvailableCountries)
                @Html.RequiredHint()
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.CountryId)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.StateProvinceId, new { }, ":")
                @Html.DropDownListFor(model => model.FillShippingInfoProof.StateProvinceId, Model.FillShippingInfoProof.AvailableStates)
                <span id="states-loading-progress" style="display: none;" class="please-wait">@T("Common.Wait...")</span>
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.StateProvinceId)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.ZipPostalCode, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.ZipPostalCode)
                @if (Model.FillShippingInfoProof.ZipPostalCodeRequired)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.ZipPostalCode)
            </div>
            <div class="inputs ">
                @Html.LabelFor(model => model.FillShippingInfoProof.PhoneNumber, new { }, ":")
                @Html.EditorFor(model => model.FillShippingInfoProof.PhoneNumber)
                @if (Model.FillShippingInfoProof.PhoneRequired)
                {
                    @Html.RequiredHint()
                }
                @Html.ValidationMessageFor(model => model.FillShippingInfoProof.PhoneNumber)
            </div>
            @Html.HiddenFor(x => x.FillShippingInfoProof.StateProvinceName)
            @Html.HiddenFor(x => x.FillShippingInfoProof.CountryName)
        </div>

        <div class="overview proof-request-form-submit-div">
            <button type="submit" id="proof-request-form-submit" name="ProofsRequestForm" class="button-1">Submit</button>
        </div>
    </form>

    }
</div>

<script>
    $("#btn-proof-request").click(function () {
        var currentCustomer = '@CurrentCustomer';
        if (currentCustomer == '') {
            window.location.href = '@Url.Action("login","customer",new { returnUrl = Url.RouteUrl("Product", new { SeName = Model.SeName }, this.Request.Url.Scheme) + "#redirectquery=artproof" })';
        }
        else {

            if ('@CurrentCustomer.IsGuest()'.toLowerCase() == 'true') {
                window.location.href = '@Url.Action("login","customer",new { returnUrl = Url.RouteUrl("Product", new { SeName = Model.SeName }, this.Request.Url.Scheme) + "#redirectquery=artproof" })';
            }
            else {
                $("#proof-dialog").dialog({
                    width: 500,
                    autoOpen: true,
                    modal: true,
                    draggable: true,
                    position: { my: "center", at: "center" },
                    resizable: true,
                    top: '10px',
                    open: function () {
                        $("#proof-request-form-submit").click(function () {
                            $("#product-details-proof-request-form").submit();

                        });
                        $('body').find('.popup-bg').removeClass('hide');
                    },
                    close: function (event, ui) {
                        $('body').find('.popup-bg').addClass('hide');
                    }
                });
            }

        }
    });
</script>

<script type="text/javascript">
    $(function () {
        $("#@Html.FieldIdFor(model => model.FillShippingInfoProof.CountryId)").change(function () {
            $("#@Html.FieldIdFor(model => model.FillShippingInfoProof.CountryName)").val($("#@Html.FieldIdFor(model => model.FillShippingInfoProof.CountryId) option:selected").html());
            var selectedItem = $(this).val();
            var ddlStates = $("#@Html.FieldIdFor(model => model.FillShippingInfoProof.StateProvinceId)");
            var statesProgress = $("#states-loading-progress");
            statesProgress.show();
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.RouteUrl("GetStatesByCountryId"))",
                data: { "countryId": selectedItem, "addSelectStateItem": "false", "addEmptyStateIfRequired": "true" },
                success: function (data) {
                    ddlStates.html('');
                    if (data.length > 0) {
                        $("#@Html.FieldIdFor(model => model.FillShippingInfoProof.StateProvinceName)").val(data[0].name);
                    }
                    $.each(data, function (id, option) {
                        ddlStates.append($('<option></option>').val(option.id).html(option.name));
                    });
                    statesProgress.hide();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve states.');
                    statesProgress.hide();
                }
            });
        });

        $("#@Html.FieldIdFor(model => model.FillShippingInfo.StateProvinceId)").change(function () {
            $("#@Html.FieldIdFor(model => model.FillShippingInfo.StateProvinceName)").val($("#@Html.FieldIdFor(model => model.FillShippingInfo.StateProvinceId) option:selected").html());
        });
    });
</script>